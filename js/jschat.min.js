Jschat={JsmvcCallback:{callback:function(a){var c=$.makeArray,b=$.isFunction,h=$.isArray,i=c(arguments),e,a=i.shift();$.isArray(a)||(a=[a]);e=this;for(var d=0;d<a.length;d++)if(typeof a[d]=="string"&&!b(this[a[d]]))throw"class.js  does not have a "+a[d]+" method!";return function(){for(var b=i.concat(c(arguments)),d,j=a.length,g=0,f;g<j;g++)if(f=a[g]){if((d=typeof f=="string")&&e._set_called)e.called=f;b=(d?e[f]:f).apply(e,b||[]);g<j-1&&(b=!h(b)||b._use_call?[b]:b)}return b}}}};
Jschat.Contact=Backbone.Model.extend({updatePrecense:function(a){a=$(a).attr("type")?$(a).attr("type"):$(a).find("show").length?$(a).find("show").text():"available";_.indexOf(Jschat.Contact.Statuses,a)>_.indexOf(Jschat.Contact.Statuses,this.status)&&this.set({status:a})}});Jschat.Contact.Statuses=["unavailable","xa","dnd","away","available","chat"];
Jschat.Roster=Backbone.Collection.extend({initialize:function(){this._freezeManager=!1;this.manager=null;this.bind("change:status",function(){this.updateManager()});this.bind("add",function(){this.updateManager()});_.bindAll(this)},freezeManager:function(){this._freezeManager=!0},updateManager:function(){if(!this._freezeManager)this.manager=this.reduce(function(a,c){if(a===null)return c;var b=_.indexOf(Jschat.Contact.Statuses,c.get("status")),h=_.indexOf(Jschat.Contact.Statuses,a.get("status"));return b>=
h?c:a},this.manager)},model:Jschat.Contact});Jschat.Roster.serializeRoster=function(a){res=[];$(a).find("item").each(function(a,b){$(b).attr("subscription")==="both"&&res.push({jid:$(b).attr("jid"),bare_jid:Strophe.getBareJidFromJid($(b).attr("jid")),name:$(b).attr("name"),status:"unavailable"})});return res};
Jschat.Message=Backbone.Model.extend({incoming:function(){var a=Strophe.getBareJidFromJid(this.to);return Strophe.getBareJidFromJid(this.myjid)===a?!0:!1},send:function(a){a.send($msg({to:this.get("to"),type:"chat"}).c("body").t(this.get("text")));return this}});Jschat.ChatLog=Backbone.Collection.extend({model:Jschat.Message});Jschat.message_template=Handlebars.compile('<div class="message {{#incoming }}in{{/incoming}}{{^incoming }}out{{/incoming}}"><div class="nick">{{#incoming }}{{ from }}{{/incoming}}{{^incoming }}\u0412\u044b:{{/incoming}}</div><div class="text">{{ text }}</div></div>');
Jschat.welcome_template=Handlebars.compile("\u0418\u043c\u044f {{ name }}, Email: {{ email }}");Jschat.viewstates={offline:0,connecting:1,online:2};
Jschat.ChatView=Backbone.View.extend({initialize:function(){this.status=Jschat.viewstates.offline;this.send_on_enter=!0;this.msgValid=!1;this.bind("change:status",this.onStatusChange);this.bind("change:msgValid",this.onMsgValidChange);this.trigger("change:status");this.bind("add:message",this.onMessageAdd);_.bindAll(this)},render:function(){this.el.show("200")},events:{"click #id_close":"destroy","focusin input,textarea":"focusin","focusout input,textarea":"focusout","change input,textarea":"onFormChange",
"keyup input,textarea":"onFormChange","keyup textarea":"onKeyUp","click #id_send":"sendMsg"},destroy:function(){this.el.hide("200")},focusin:function(a){$("label[for="+$(a.target).attr("id")+"]").hide()},focusout:function(a){$(a.target).val()===""&&$("label[for="+$(a.target).attr("id")+"]").show()},onFormChange:function(){this.msgValid=this.el.find("#id_full_name").val().length>0&&this.el.find("#id_text").val().length>0?!0:!1;this.trigger("change:msgValid")},onKeyUp:function(a){a.keyCode==13&&this.send_on_enter&&
this.sendMsg(a)},getUserinfo:function(){return{name:this.el.find("#id_full_name").val(),email:this.el.find("#id_email").val()}},setStatus:function(a){switch(a){case Jschat.viewstates.offline:this.status=Jschat.viewstates.offline;break;case Jschat.viewstates.connecting:this.status=Jschat.viewstates.connecting;break;case Jschat.viewstates.online:this.status=Jschat.viewstates.online}this.trigger("change:status")},sendMsg:function(a){a.preventDefault();this.status===Jschat.viewstates.online&&this.msgValid&&
(this.trigger("send:message",this.el.find("textarea").val()),this.clear());return!0},clear:function(){this.el.find("textarea").val("")},onStatusChange:function(){switch(this.status){case Jschat.viewstates.online:this.msgValid&&this.el.find("#id_send").removeAttr("disabled").removeClass("disabled");break;case Jschat.viewstates.offline:this.el.find("#id_send").attr("disabled","disabled").addClass("disabled")}},onMsgValidChange:function(){this.msgValid?this.status===Jschat.viewstates.online&&this.el.find("#id_send").removeAttr("disabled").removeClass("disabled"):
this.el.find("#id_send").attr("disabled","disabled").addClass("disabled")},onMessageAdd:function(a){this.el.find("#online-messages").is(":hidden")&&this.el.find("#online-messages").show(200);var c=this.el.find("#online-message-list");c.append(Jschat.message_template(a.toJSON()));c.scrollTop(c[0].scrollHeight)}});Jschat.Xmpp=function(a){a||(a={});this.defaults&&(a=_.extend(this.defaults,a));this.options=a;this.initialize()};
_.extend(Jschat.Xmpp.prototype,Jschat.JsmvcCallback,Backbone.Events,{defaults:{jid:"jschat-demo@jabber.org",password:"password",bosh_service:"http://bosh.metajack.im:5280/xmpp-httpbind",view_el_id:"online-block"},initialize:function(){this.connection=new Strophe.Connection(this.options.bosh_service);this.roster=new Jschat.Roster;this.chatlog=new Jschat.ChatLog;this.view=new Jschat.ChatView({el:$("#"+this.options.view_el_id)});this._welcomeSent=!1;this.bind("connected",this.onConnect);this.options.autoConnect&&
this.connect();this.chatlog.bind("add",this.callback("onMessageAdd"));this.view.bind("send:message",this.callback("sendMessage"))},connect:function(){this.connection.connect(this.options.jid,this.options.password,this.callback("onConnectChange"));this.trigger("ui:connect")},onConnectChange:function(a){for(st in Strophe.Status)a===Strophe.Status[st]&&console.log("status: "+st);a===Strophe.Status.CONNECTED&&this.trigger("connected")},onConnect:function(){this.connection.sendIQ($iq({type:"get"}).c("query",
{xmlns:"jabber:iq:roster"}),this.callback("onRoster"));this.trigger("ui:roster");this.connection.addHandler(this.callback("onContactPresence"),null,"presence");this.connection.addHandler(this.callback("onMessage"),null,"message","chat")},onRoster:function(a){this.connection.send($pres());this.trigger("ui:ready");this.view.setStatus(Jschat.viewstates.online);for(var a=Jschat.Roster.serializeRoster(a),c=0;c<a.length;c++)this.roster.add(a[c]);return!0},onContactPresence:function(a){var c=Strophe.getBareJidFromJid($(a).attr("from")),
b=this.roster.detect(function(a){return a.get("bare_jid")===c});b&&b.updatePrecense(a);this.options.autoChat&&_.delay(function(a){a.sendWelcome()},"2000",this);return!0},sendWelcome:function(){if(!this._welcomeSent){var a=this.getUserinfo();this.roster.freezeManager();this._welcomeSent=!0;this.sendMessage({text:a,from:this.options.jid,to:this.roster.manager.get("jid"),hidden:!0,dt:new Date})}},sendMessage:function(a){this._welcomeSent||this.sendWelcome();a=typeof a==="string"?new Jschat.Message({text:a,
from:this.options.jid,to:this.roster.manager.get("jid"),incoming:!1,dt:new Date}):new Jschat.Message(a);a.send(this.connection);a.get("hidden")||this.chatlog.add(a)},getUserinfo:function(){return Jschat.welcome_template(this.view.getUserinfo())},onMessage:function(a){this.chatlog.add(new Jschat.Message({text:$(a).find("body").text(),from:$(a).attr("from"),to:$(a).attr("to"),incoming:!0,dt:new Date}));return!0},onMessageAdd:function(a){this.view.trigger("add:message",a)}});